kotlin:
  targets:
    - iosArm64
    - iosX64
    - iosSimulatorArm64
    # apply to all above native targets
    - native:
        compilerOptions:
          optIns:
            - kotlin.experimental.ExperimentalObjCName
            - kotlin.experimental.ExperimentalNativeApi
            - kotlinx.cinterop.ExperimentalForeignApi
            - kotlinx.cinterop.BetaInteropApi
            - kotlinx.cinterop.UnsafeNumber
          freeCompilerArgs:
            - -Xexport-kdoc
            - -Xallocator=custom
            - -XXLanguage+ImplicitSignedToUnsignedIntegerConversion
            - -Xadd-light-debug=enable
        binaries:
          framework:
            # add it to avoid sqllite3 issues in iOS. Required when using NativeSQLiteDriver
            linkerOpts:
              - -lsqlite3
          test:
            buildTypes: [ RELEASE ]
    - nativeWithTests:
        testRuns:
          - releaseTest:
              executionSourceFrom: RELEASE
    - js:
        devServer:
          static: [ src@js ]
    - wasmJs:
        devServer:
          static: [ src@wasmJs ]
    # apply to all above js and wasm targets
    - jsCommon:
        devServer:
          static:
            # serve sources to debug inside browser
            - ../ # root directory
            - ./ # project directory

        compilerOptions:
          optIns:
            - kotlin.js.ExperimentalJsExport
        browser:
          commonWebpackConfig:
            cssSupport:
              enabled: true
          testTask:
            testLogging:
              showStandardStreams: true
            useKarmaDsl:
              configDirectory: ../karma.config.d
              useChromeHeadless: true
        nodejs:
          testTask:
            useMochaDsl:
              timeout: 600s

  hierarchy:
    - jvmCommon: [ jvm, android ]
    - nonJvm: [ mobile, web ]
    - nonAndroid: [ jvm, ios, web ]
    - androidNative32: [ androidNativeArm32,androidNativeX86 ]
    - androidNative64: [ androidNativeX64, androidNativeArm64 ]
    - androidNative: [ androidNative32, androidNative32 ]
    - apple32: [ watchosArm32, watchosArm64 ] # NB watchosArm64 is weird target w/ 32-bit numbers.
    - apple64: [ ios, macos, tvos, watchosX64, watchosDeviceArm64, watchosSimulatorArm64 ]
    - apple: [ apple32, apple64 ]
    - nonIos: [ jvmCommon, web ]
    - nix: [ linux, apple, androidNative ]
    - posix: [ mingw, nix ]
    - nativeNonApple: [ mingw, unix, linux, androidNative ]
    - nativeNonAndroid: [ apple, mingw, linux ]
    - native: [ nativeNonApple, nativeNonAndroid ]
    - mobile: [ android, ios ]
    - nonMobile: [ jvm, web ]
    - desktop: [ linux, windows, macos ]
    - multithreaded: [ jvmCommon, native ]
    - jsCommon: [ js, wasmJs ]
    - web: [ jsCommon, wasmWasi ]
    - nonWeb: [ jvmCommon, ios ]
    - wasm: [ wasmJs, wasmWasi ]

  sourceSets:
    - jsMain:
        dependencies:
          - kotlin: test-js
          #          - npm: $libs.js.joda.timezone
          - npm: $libs.npm.copy.webpack.plugin
          - npm: $libs.npm.openpgp
          - npm: $libs.npm.pako
          - npm: $libs.npm.puppeteer

  #    - wasmJsMain:
  #        dependencies:
  #          - $kotlinWrappers.browser
  cocoapods:
    ios: { }

tasks:
  - Kotlin2JsCompile:
      compilerOptions:
        target: es2015
      freeCompilerArgs:
        - -Xdont-warn-on-error-suppression
        - -Xir-generate-inline-anonymous-functions #  https://youtrack.jetbrains.com/issue/KT-67355
        - -Xsuppress-warning=NOTHING_TO_INLINE
        - -Xpartial-linkage-loglevel=ERROR
  - KotlinNpmInstallTask:
      args: [ --ignore-engines ]

config:
  imports:
    - org.jetbrains.kotlin.gradle.targets.jvm.KotlinJvmTarget
    - org.jetbrains.kotlin.gradle.targets.jvm.tasks.KotlinJvmTest
    - org.jetbrains.kotlin.gradle.plugin.KotlinPlatformType
    - gradle.plugins.kotlin.targets.jvm.registerJavaCodegenTestTask
script:
  - kotlin:
      jvm: |
        {
          compilations.all { compilation ->
            // Force Gradle to use JVM variants for multiplatform deps.
            compilation.compileDependencyConfigurationName.let { configName ->
              project.configurations.named(configName) {
                  attributes {
                      attribute(KotlinPlatformType.attribute, KotlinPlatformType.jvm)
                  }
              }
            }
          }
        }
      targets:
        - withType<KotlinJvmTarget>: |
            {
              compilerOptions {
                jvmTarget /= libs.versions("jvm.target").requiredVersion.toJvmTarget()
                freeCompilerArgs.addAll(
                   "-Xno-param-assertions",
                   "-Xno-call-assertions",
                   "-Xno-receiver-assertions"
                )
                optIn.addAll(
                  "-Xjvm-default=all",
                )
              }

              createJavaCodegenTest
            }
      sourceSets:
        - named: |
            ("jvmMain") { sourceSet ->
              sourceSet.dependencies {
                implementation(libs["logback.classic"])
                implementation(libs["jnativehook"])
                implementation(libs.bundles("jna"))
                implementation(libs["webrtc.java"])
                implementation(libs.bundles("jdbc"))
                implementation(libs.bundles("r2dbc"))
                implementation(libs.bundles("kotysa"))
                implementation(libs.bundles("exposed"))
                // implementation(libs["dataframe"])
                implementation(libs["kandy"])
                implementation(libs.bundles("ktor.server"))
                implementation(libs("ktor")["server.rateLimit"])
                implementation(libs("ktor")["network.tls"])
                implementation(libs("ktor")["network.tls.certificates"])
                implementation(libs("ktor")["server.core"])
                implementation(libs("ktor")["server.websockets"])
                implementation(libs("ktor")["server.di"])
                implementation(libs("ktor")["server.contentNegotiation"])
                implementation(libs("ktor")["server.freemarker"])
                implementation(libs("ktor")["server.callLogging"])
                implementation(libs("ktor")["server.callId"])
                implementation(libs("ktor")["server.statusPages"])
                implementation(libs("ktor")["server.sse"])
                implementation(libs("ktor")["server.resources"])
                implementation(libs("ktor")["server.requestValidation"])
                implementation(libs("ktor")["server.autoHeadResponse"])
                implementation(libs("ktor")["server.doubleReceive"])
                implementation(libs("ktor")["server.sessions"])
                implementation(libs("ktor")["server.auth"])
                implementation(libs("ktor")["server.csrf"])
                implementation(libs("ktor")["client.apache"])
                implementation(libs("ktor")["server.auth.ldap"])
                implementation(libs("ktor")["server.auth.jwt"])
                implementation(libs("ktor")["server.swagger"])
                implementation(libs("ktor")["server.partialContent"])
                implementation(libs("ktor")["server.openapi"])
                implementation(libs("ktor")["server.httpRedirect"])
                implementation(libs("ktor")["server.hsts"])
                implementation(libs("ktor")["server.forwardedHeader"])
                implementation(libs("ktor")["server.defaultHeaders"])
                implementation(libs("ktor")["server.cors"])
                implementation(libs("ktor")["server.conditionalHeaders"])
                implementation(libs("ktor")["server.compression"])
                implementation(libs("ktor")["server.cachingHeaders"])
                implementation(libs("ktor")["server.dataConversion"])
                implementation(libs("ktor")["server.methodOverride"])
                implementation(libs("ktor")["server.netty"])
                implementation(libs("ktor")["server.config.yaml"])
                implementation(libs["swagger.codegen.generators"])
                implementation(libs.bundles("ktor.openapi"))
                implementation(libs["firebase.auth.provider"])
                implementation(libs.bundles("kotlinx.rpc.server"))
                implementation(libs["graphql.kotlin.ktor.server"])
                implementation(libs.bundles("metrics"))
                implementation(libs["jxmapviewer2"])
                implementation(libs.bundles("koin.ktor"))

                // To enable HTTP/2 in Netty, use OpenSSL bindings (See https://netty.io/wiki/forked-tomcat-native.html).
                val osName = System.getProperty("os.name").lowercase()
                val tcnative_version = libs.versions("tcnative").requiredVersion
                val tcnative_classifier = when {
                  osName.contains("win") -> "windows-x86_64"
                  osName.contains("linux") -> "linux-x86_64"
                  osName.contains("mac") -> "osx-x86_64"
                  else -> null
                }

                if (tcnative_classifier != null)
                  implementation("io.netty:netty-tcnative-boringssl-static:$tcnative_version:$tcnative_classifier")
                else implementation("io.netty:netty-tcnative-boringssl-static:$tcnative_version")
              }
            }
        - named: |
            ("jvmTest") { sourceSet ->
              sourceSet.dependencies {
                implementation(libs["kotest.runner.junit5"])
                implementation(libs("ktor")["server.testHost"])
                implementation(libs["koin.test.junit5"])
              }
            }
  - tasks:
      - withType<KotlinJvmTest>: |
          {
            maxHeapSize = "2g"

            useJUnitPlatform()

            filter { filter ->
              filter.isFailOnNoMatchingTests = false
            }

            testLogging { testLogging ->
              testLogging.showExceptions = true
              testLogging.showStandardStreams = true
              testLogging.events = setOf(TestLogEvent.FAILED, TestLogEvent.PASSED)
              testLogging.exceptionFormat = TestExceptionFormat.FULL
            }
          }

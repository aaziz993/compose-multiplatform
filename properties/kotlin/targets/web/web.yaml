config:
  imports:
    - org.jetbrains.kotlin.gradle.targets.js.dsl.KotlinJsTargetDsl
    - org.jetbrains.kotlin.gradle.tasks.Kotlin2JsCompile
    - org.jetbrains.kotlin.gradle.targets.js.npm.tasks.KotlinNpmInstallTask
    - org.jetbrains.kotlin.gradle.targets.js.yarn.YarnPlugin
    - org.jetbrains.kotlin.gradle.targets.js.yarn.YarnLockMismatchReport
    - org.jetbrains.kotlin.gradle.targets.js.yarn.YarnRootExtension
    - org.jetbrains.kotlin.gradle.targets.js.nodejs.NodeJsRootPlugin
    - gradle.plugins.kotlin.targets.web.node.*
    - gradle.plugins.kotlin.targets.web.yarn.*
script:
  - kotlin:
      targets:
        - withType<KotlinJsTargetDsl>: |
            {
              outputModuleName.set(project.pathUnderscore)
              browser {
                val rootDirPath = project.rootDir.path
                val projectDirPath = project.projectDir.path

                commonWebpackConfig { commonWebpackConfig ->
                  commonWebpackConfig.devServer = (commonWebpackConfig.devServer ?: KotlinWebpackConfig.DevServer()).apply {
                      static = (static ?: mutableListOf()).apply {
                          // Serve sources to debug inside browser
                          add(rootDirPath)
                          add(projectDirPath)
                      }
                  }

                  commonWebpackConfig.cssSupport { cssSupport ->
                    cssSupport.enabled /= true
                  }
                }

                testTask { testTask ->
                  testTask.testLogging { testLogging ->
                      testLogging.showStandardStreams = true
                  }

                  testTask.useKarma {
                      useChromeHeadless()
                  }
                }
              }
              generateTypeScriptDefinitions()
            }
      sourceSets:
        - named: |
            ("webMain") { sourceSet ->
              sourceSet.dependencies {
                implementation(libs("kotlinWrappers")["browser"])
                implementation(libs["compass.geolocation.browser"])
                implementation(libs["kstore.storage"])
                implementation(libs["sqldelight.web.worker.driver"])
                implementation(npm("@js-joda/timezone", libs.versions("npm.js.joda.timezone").requiredVersion))
                implementation(npm("@cashapp/sqldelight-sqljs-worker", libs.versions("sqldelight").requiredVersion))
                implementation(npm("sql.js", libs.versions("npm.sql.js").requiredVersion))
                implementation(devNpm("copy-webpack-plugin", libs.versions("npm.copy.webpack.plugin").requiredVersion))
                implementation(npm("openpgp", libs.versions("npm.openpgp").requiredVersion))
                implementation(npm("pako", libs.versions("npm.pako").requiredVersion))
                implementation(npm("puppeteer", libs.versions("npm.puppeteer").requiredVersion))
              }
            }
  # TODO remove if https://youtrack.jetbrains.com/issue/KT-55701 provides a better
  - rootProject.plugins.withType<YarnPlugin>: |
      {
        rootProject.yarn.yarnLockMismatchReport = YarnLockMismatchReport.WARNING // NONE | FAIL
        rootProject.yarn.reportNewYarnLock = true
        rootProject.yarn.yarnLockAutoReplace = true
      }
  # TODO Remove when it's fixed https://github.com/antelle/argon2-browser/issues/81
  - rootProject.plugins.withType<NodeJsRootPlugin>: |
      {
        rootProject.nodeJsEnv.version /= "24.7.0"
      }
  - tasks:
      - withType<KotlinNpmInstallTask>: |
          {
            args.addAll(listOf(
              "--ignore-engines",
              "--ignore-scripts",
            ))
          }
      - withType<Kotlin2JsCompile>: |
          {
            compilerOptions {
                target /= "es2015"
                freeCompilerArgs.addAll(
                  "-Xskip-prerelease-check",
                  "-Xpartial-linkage-loglevel=INFO",
                  "-Xdont-warn-on-error-suppression",
                  // https://youtrack.jetbrains.com/issue/KT-67355
                  "-Xir-generate-inline-anonymous-functions",
                )
            }
          }

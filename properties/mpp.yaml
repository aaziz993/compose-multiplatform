config:
  imports:
    - org.jetbrains.kotlin.gradle.plugin.mpp.KotlinNativeTarget
    - org.jetbrains.kotlin.gradle.plugin.mpp.KotlinNativeTargetWithTests
    - org.jetbrains.kotlin.gradle.plugin.mpp.NativeBuildType
    - org.jetbrains.kotlin.gradle.targets.js.webpack.KotlinWebpackConfig
    - org.jetbrains.kotlin.gradle.targets.jvm.tasks.KotlinJvmTest
    - org.jetbrains.kotlin.gradle.targets.jvm.KotlinJvmTarget
    - org.jetbrains.kotlin.gradle.ExperimentalWasmDsl
    - org.jetbrains.kotlin.gradle.targets.js.dsl.KotlinWasmJsTargetDsl
    - org.jetbrains.kotlin.gradle.targets.js.webpack.KotlinWebpackConfig
    - org.jetbrains.kotlin.gradle.targets.js.dsl.KotlinJsTargetDsl
    - org.jetbrains.kotlin.gradle.tasks.Kotlin2JsCompile
    - org.jetbrains.kotlin.gradle.targets.js.npm.tasks.KotlinNpmInstallTask
script:
  - '@file:OptIn': (ExperimentalWasmDsl::class)
  - plugins:
      - id: (libs.plugins("kotlin.multiplatform").pluginId)
      # Converter of TypeScript declaration files to Kotlin declarations.
#      - id: (libs.plugins("karakum").pluginId)
  - kotlin:
      jvm: ()
      iosArm64: ()
      iosX64: ()
      iosSimulatorArm64: ()
      js: |
        {
          browser {
            commonWebpackConfig { commonWebpackConfig ->
              commonWebpackConfig.devServer = (commonWebpackConfig.devServer ?: KotlinWebpackConfig.DevServer()).apply {
                static = (static ?: mutableListOf()).apply{
                  add("src@js")
                }
              }
            }
          }
        }
      wasmJs: |
        {
          browser {
            commonWebpackConfig { commonWebpackConfig ->
              commonWebpackConfig.devServer = (commonWebpackConfig.devServer ?: KotlinWebpackConfig.DevServer()).apply {
                  static = (static ?: mutableListOf()).apply{
                    add("src@wasmJs")
                  }
              }
            }
          }
        }
      targets:
        - withType<KotlinJvmTarget>: |
            {
              compilerOptions {
                freeCompilerArgs.addAll(
                   "-Xno-param-assertions",
                   "-Xno-call-assertions",
                   "-Xno-receiver-assertions"
                )
                optIn.addAll(
                  "-Xjvm-default=all",
                )
              }
            }
        - withType<KotlinNativeTarget>: |
            {
              compilerOptions {
                optIn.addAll(
                  "kotlin.experimental.ExperimentalObjCName",
                  "kotlin.experimental.ExperimentalNativeApi",
                  "kotlinx.cinterop.ExperimentalForeignApi",
                  "kotlinx.cinterop.BetaInteropApi",
                  "kotlinx.cinterop.UnsafeNumber",
                )
            
                freeCompilerArgs.addAll(
                  "-Xexport-kdoc",
                  "-Xallocator=custom",
                  "-XXLanguage+ImplicitSignedToUnsignedIntegerConversion",
                  "-Xadd-light-debug=enable",
                )
              }
              binaries {
                framework {
                  // add it to avoid sqllite3 issues in iOS . Required when using NativeSQLiteDriver
                  linkerOpts.addAll(listOf("--lsqlite3"))
                }
            
                test(listOf(NativeBuildType.RELEASE))
              }
            }
        - withType<KotlinNativeTargetWithTests<*>>: |
            {
              testRuns.register("releaseTest") { testRun ->
                  testRun.setExecutionSourceFrom(binaries.getTest(NativeBuildType.RELEASE))
              }
            }
        - withType<KotlinJsTargetDsl>: |
            {
              compilerOptions.optIn.addAll(
                "kotlin.js.ExperimentalJsExport",
              )
            
              browser {
                val rootDirPath = project.rootDir.path
                val projectDirPath = project.projectDir.path
            
                commonWebpackConfig { commonWebpackConfig ->
                  commonWebpackConfig.devServer = (commonWebpackConfig.devServer ?: KotlinWebpackConfig.DevServer()).apply {
                      static = (static ?: mutableListOf()).apply {
                          // Serve sources to debug inside browser
                          add(rootDirPath)
                          add(projectDirPath)
                      }
                  }
            
                  commonWebpackConfig.cssSupport { cssSupport ->
                    cssSupport.enabled /= true
                  }
                }
            
                testTask { testTask ->
                  testTask.testLogging { testLogging ->
                      testLogging.showStandardStreams = true
                  }
            
                  testTask.useKarma {
                      useChromeHeadless()
                  }
                }
              }
            }
      applyDefaultHierarchyTemplate: |
        {
          common {
            group("jvmCommon") {
              withJvm()
              withAndroidTarget()
            }
            group("jvmCommonIos") {
              group("jvmCommon")
              withIos()
            }
            group("jvmIosWeb") {
              withJvm()
              withIos()
              group("web")
            }
            group("jvmWeb") {
              withJvm()
              group("web")
            }
            group("androidIos") {
              withAndroidTarget()
              withIos()
            }
            group("androidIosWeb") {
              group("androidIos")
              group("web")
            }
            group("androidNative32") {
              withAndroidNativeArm32()
              withAndroidNativeX86()
            }
            group("androidNative64") {
              withAndroidNativeX64()
              withAndroidNativeArm64()
            }
            group("androidNative") {
              group("androidNative32")
              group("androidNative64")
            }
            group("apple32") {
              withWatchosArm32()
              withWatchosArm64()  // NB watchosArm64 is weird target w/ 32-bit numbers.
            }
            group("apple64") {
              withIos()
              withMacos()
              withTvos()
              withWatchosX64()
              withWatchosDeviceArm64()
              withWatchosSimulatorArm64()
            }
            group("apple") {
              group("apple32")
              group("apple64")
            }
            group("nonIos") {
              group("jvmCommon")
              group("web")
            }
            group("nix") {
              withLinux()
              withApple()
              withAndroidNative()
            }
            group("posix") {
              withMingw()
              group("nix")
            }
            group("nativeNonApple") {
              withAndroidNative()
              withMingw()
              withLinux()
            }
            group("nativeNonAndroid") {
              withApple()
              withMingw()
              withLinux()
            }
            group("native") {
              withNative()
            }
            group("desktop") {
              withLinux()
              withMingw()
              withMacos()
            }
            group("multithreaded") {
              group("jvmCommon")
              withNative()
            }
            group("jsCommon") {
              withJs()
              withWasmJs()
            }
            group("wasm") {
              withWasmJs()
              withWasmWasi()
            }
            group("web") {
              group("jsCommon")
              withWasmWasi()
            }
          }
        }
      sourceSets:
        - named: |
            ("commonMain") { sourceSet ->
              sourceSet.dependencies {
                implementation(libs("atomicfu"))
                implementation(libs("kotlinx.serialization.json"))
                implementation(libs("kotlinx.serialization.properties"))
                implementation(libs("kotlinx.benchmark.runtime"))
              }
            }
        # Jvm.
        - named: |
            ("jvmMain") { sourceSet ->
              sourceSet.dependencies {
                implementation(libs("logback.classic"))
                implementation(libs("reflections"))
                implementation(libs("jackcess"))
                implementation(libs("jnativehook"))
                 implementation(libs.bundles("jna"))
                implementation(libs("webrtc.java"))
                implementation(libs.bundles("webcam.capture"))
                implementation(libs("kotlinx.coroutines.swing"))
                implementation(libs.bundles("jdbc"))
                implementation(libs.bundles("r2dbc"))
                implementation(libs.bundles("kotysa"))
                implementation(libs.bundles("exposed"))
                implementation(libs("dataframe"))
                implementation(libs("kandy"))
                implementation(libs("ktor.serialization.kotlinx.xml"))
                implementation(libs.bundles("ktor.server"))
                implementation(libs.bundles("kotlinx.rpc.server"))
                implementation(libs.bundles("kgraphql"))
                implementation(libs.bundles("metrics"))
                implementation(libs("jxmapviewer2"))
                implementation(libs.bundles("koin.ktor"))
              }
            }
        - named: |
            ("jvmTest") { sourceSet ->
              sourceSet.dependencies {
                implementation(libs("kotest.runner.junit5"))
                implementation(libs("ktor.server.test.host"))
                implementation(libs("koin.test.junit5"))
              }
            }
        # Jvm and android.
        - named: |
            ("jvmCommonMain") { sourceSet ->
              sourceSet.dependencies {
                implementation(dependencies.kotlin("stdlib"))
                implementation(libs("worldwind"))
              }
            }
        - named: |
            ("jvmCommonTest") { sourceSet ->
              sourceSet.dependencies {
                implementation(libs("mockito.core"))
                implementation(libs("mockito.kotlin"))
                implementation(libs("truth"))
              }
            }
        # Ios.
        - named: |
            ("iosMain") { sourceSet ->
              sourceSet.dependencies {
                implementation(libs("cryptography.provider.openssl3"))
                implementation(libs("sqldelight.native.driver"))
                implementation(libs("ktor.client.darwin"))
                implementation(libs("permissions"))
              }
            }
        # Android and ios.
        - named: |
            ("androidIosTest") { sourceSet ->
              sourceSet.dependencies {
                implementation(libs("permissions.test"))
              }
            }
        # Jvm, android and ios.
        - named: |
            ("jvmCommonIosMain") { sourceSet ->
              sourceSet.dependencies {
                implementation(libs("androidx.room.runtime.ktx"))
                implementation(libs("androidx.sqlite.bundled"))
              }
            }
        # Js.
        - named: |
            ("jsMain") { sourceSet ->
              val karakumGeneratedDir = projectDir.resolve("src/jsMain/generated")
              if (karakumGeneratedDir.exists()) {
                sourceSet.kotlin.srcDir(karakumGeneratedDir)
              }

              sourceSet.dependencies {
                implementation(libs("seskar"))
                implementation(libs("kstore.storage"))
                implementation(libs("sqldelight.web.worker.driver"))
                implementation(libs("compass.geolocation.browser"))
                implementation(libs("worldwind"))
                implementation(libs("ktor.client.js"))
                implementation(npm("@js-joda/timezone", libs.versions("npm.js.joda.timezone")!!.requiredVersion))
                implementation(devNpm("copy-webpack-plugin", libs.versions("npm.copy.webpack.plugin")!!.requiredVersion))
                implementation(npm("openpgp", libs.versions("npm.openpgp")!!.requiredVersion))
                implementation(npm("pako", libs.versions("npm.pako")!!.requiredVersion))
                implementation(npm("puppeteer", libs.versions("npm.puppeteer")!!.requiredVersion))
              }
            }
        - named: |
            ("jsTest") { sourceSet ->
              sourceSet.dependencies {
                implementation(kotlin("test-js"))
              }
            }
        # WasmJs.
        - named: |
            ("wasmJsMain") { sourceSet ->
              sourceSet.dependencies {
                // implementation(kotlinWrappers["browser"])
              }
            }
        # Jvm, js, wasmJs.
        - named: |
            ("jvmWebMain") { sourceSet ->
              sourceSet.dependencies {
                implementation(libs("compass.geocoder.web.googlemaps"))
              }
            }
        # Android, ios, js and wasmJs.
        - named: |
            ("androidIosWebMain") { sourceSet ->
              sourceSet.dependencies {
                implementation(libs("webrtc.kmp"))
              }
            }
  #      cocoapods:
#        ios: { }
  - tasks:
      # Jvm.
      - withType<KotlinJvmTest>: |
          {
            maxHeapSize = "2g"
          
            useJUnitPlatform()
          
            filter { filter ->
              filter.isFailOnNoMatchingTests = false
            }
          
            testLogging { testLogging ->
              testLogging.showExceptions = true
              testLogging.showStandardStreams = true
              testLogging.events = setOf(TestLogEvent.FAILED, TestLogEvent.PASSED)
              testLogging.exceptionFormat = TestExceptionFormat.FULL
            }
          }
      # Js.
      - withType<KotlinNpmInstallTask>: |
          {
            args.addAll(listOf(
              "--ignore-engines",
              "--ignore-scripts",
            ))
          }
      - withType<Kotlin2JsCompile>: |
          {
            compilerOptions {
                target /= "es2015"
                freeCompilerArgs.addAll(
                    "-Xdont-warn-on-error-suppression",
                    //  https://youtrack.jetbrains.com/issue/KT-67355
                    "-Xir-generate-inline-anonymous-functions",
                    "-Xsuppress-warning=NOTHING_TO_INLINE",
                    "-Xpartial-linkage-loglevel=ERROR",
                )
            }
          }

# Converter of TypeScript declaration files to Kotlin declarations.
#karakum:
#  configFile: karakum.config.json
config:
  imports:
    - kotlinx.benchmark.gradle.JvmBenchmarkTarget
    - kotlinx.rpc.RpcStrictMode
    - com.github.jengelman.gradle.plugins.shadow.tasks.ShadowJar
    - org.gradle.api.file.DuplicatesStrategy
    - gradle.plugins.spotless.*
script:
  # Flatten source code directories.
  - flatten: ()
  - group: '"io.github.aaziz993"'
  - plugins:
      - id: (libs.plugins("dependencycheck").pluginId)
      - id: (libs.plugins("buildconfig").pluginId)
      - id: (libs.plugins("spotless").pluginId)
      - id: (libs.plugins("sonarqube").pluginId)
      - id: (libs.plugins("binaryCompatibilityValidator").pluginId)
      - id: (libs.plugins("ksp").pluginId)
      - id: (libs.plugins("allopen").pluginId)
      - id: (libs.plugins("noarg").pluginId)
      - id: (libs.plugins("atomicfu").pluginId)
      - id: (libs.plugins("kotlin.serialization").pluginId)
      - id: (libs.plugins("kotlinx.benchmark").pluginId)
      - id: (libs.plugins("sqldelight").pluginId)
      - id: (libs.plugins("room").pluginId)
      - id: (libs.plugins("kotlinx.rpc").pluginId)
      - id: (libs.plugins("ktorfit").pluginId)
      - id: (libs.plugins("apollo3").pluginId)
      - id: (libs.plugins("powerAssert").pluginId)
  - kotlin:
      explicitApi: ExplicitApiMode.Strict
      compilerOptions:
        allWarningsAsErrors: false
        progressiveMode: true
        suppressWarnings: false
        verbose: true
        optIn.addAll: |
          (
            "kotlin.RequiresOptIn",
            "kotlin.ExperimentalSubclassOptIn",
            "kotlin.ExperimentalStdlibApi",
            "kotlin.ExperimentalUnsignedTypes",
            "kotlin.ExperimentalUuidApi",
            "kotlin.time.ExperimentalTime",
            "kotlin.ExperimentalAtomicApi",
            "kotlin.contracts.ExperimentalContracts",
            "kotlin.experimental.ExperimentalObjCName",
            "kotlin.js.ExperimentalJsExport",
            "kotlinx.coroutines.ExperimentalCoroutinesApi",
            "kotlinx.coroutines.DelicateCoroutinesApi",
            "kotlinx.coroutines.FlowPreview",
            "kotlinx.serialization.ExperimentalSerializationApi",
            "kotlinx.serialization.InternalSerializationApi",
            "dev.whyoleg.cryptography.DelicateCryptographyApi",
          )
        freeCompilerArgs.addAll: |
          (
            "-Xignore-const-optimization-errors",
            "-Xexplicit-api=strict",
            "-Xexport-kdoc",
            "-Xinline-classes",
            "-Xwhen-guards",
            "-Xnon-local-break-continue",
            "-Xexpect-actual-classes",
            "-Xcontext-parameters",
            "-Xmulti-dollar-interpolation",
            "-Xrender-internal-diagnostic-names",
            "-Xbinary=preCodegenInlineThreshold=40"
          )
      targets:
        - withType<KotlinJsTargetDsl>: |
            {
              compilerOptions.optIn.addAll(
                "-Xjvm-default=all",
              )
            }
  #  sourceSets:
  #    - commonMain:
  #        dependencies:
  #          - $libs.atomicfu
  #          - $libs.kotlinx.serialization.json
  #          - $libs.kotlinx.serialization.properties
  #          - $libs.kotlinx.benchmark.runtime
  #
  #    - nonWebMain:
  #        dependencies:
  #          - $libs.androidx.room.runtime.ktx
  #
  ## Software Composition Analysis (SCA) tool that attempts to detect publicly disclosed vulnerabilities contained within a project's dependencies. It does this by determining if there is a Common Platform Enumeration (CPE) identifier for a given dependency. If found, it will generate a report linking to the associated CVE entries.
  - dependencyCheck:
      outputDirectory: '"build/reports"'
      format: '"ALL"'
  # Generating BuildConstants for any kind of Gradle projects: Java, Kotlin, Android, Groovy, etc. Designed for KTS scripts, with experimental support for Kotlin's multi-platform plugin
  - buildconfig: { }
  # Can format <antlr | c | c# | c++ | css | flow | graphql | groovy | html | java | javascript | json | jsx | kotlin | less | license headers | markdown | objective-c | protobuf | python | scala | scss | shell | sql | typeScript | vue | yaml | anything> using <gradle | maven | sbt | anything>.
  - spotless:
      - java: | 
          {
            replaceRegex("remove license header", """^\s*(//.*|/\*[\s\S]*?\*\/)\s*""", "")
            // specify license header text
            licenseHeader("../licenses/LICENSE_HEADER_SLASHED", "^")
            // include source files
            target("**/*.java")
            // uses the default importOrder configuration
            importOrder()
            // removes any unused imports from any of your Java classes
            removeUnusedImports()
            // Tells spotless to format according to the Google Style Guide
            // (https://google.github.io/styleguide/javaguide.html)
            googleJavaFormat().apply {
            groupArtifact("com.google.googlejavaformat:google-java-format")
            reflowLongStrings(true)
            reorderImports(true)
            formatJavadoc(false)
            }
            // fixes formatting of type annotations
            formatAnnotations()
            // cleanthat will refactor your code, but it may break your style: apply it before your formatter
            cleanthat()
          }
      - kotlin: |
          {
            // use ktlint with version and custom .editorconfig
            ktlint().setEditorConfigPath("../.editorconfig")
            // remove old license header
            replaceRegex("remove license header", """^\s*(//.*|/\*[\s\S]*?\*\/)\s*""", "")
            // specify license header text
            licenseHeader("../licenses/LICENSE_HEADER_SLASHED", "^")
            // include source files
            target("**/*.kt", "**/*.kts")
          }
      - kotlinGradle: |
          {
            // use ktlint with version and custom .editorconfig
            ktlint().setEditorConfigPath("../.editorconfig")
            // remove old license header
            replaceRegex("remove license header", """^\s*(//.*|/\*[\s\S]*?\*\/)\s*""", "")
            // specify license header text
            licenseHeader("../licenses/LICENSE_HEADER_SLASHED", "^")
            // include source files
            target("**/*.gradle.kts")
          }
      - javascript: |
          {
            // remove old license header
            replaceRegex("remove license header", """^\s*(//.*|/\*[\s\S]*?\*\/)\s*""", "")
            // specify license header text
            licenseHeader("../licenses/LICENSE_HEADER_SLASHED", "^")
            // include source files
            target("**/*.js")
          }
      - typescript: |
          {
            // remove old license header
            replaceRegex("remove license header", """^\s*(//.*|/\*[\s\S]*?\*\/)\s*""", "")
            // specify license header text
            licenseHeader("../licenses/LICENSE_HEADER_SLASHED", "^")
            // include source files
            target("**/*.ts")
          }
      - json: | 
          {
            // include source files
            target("**/*.json")
          }
      - yaml: |
          {
            // specify license header text
            licenseHeader("../licenses/LICENSE_HEADER_SHARPED", """^(?!\s*#).*""")
            // include source files
            target("**/*.yaml", "**/*.yml")
          }
      - format: |
          ("xml") {
            // remove old license header
            replaceRegex("remove license header", """^\s*<--[\s\S]*?-->\s*""", "")
            // specify license header text
            licenseHeader("../licenses/LICENSE_HEADER_TAGGED", "^")
            // include source files
            target("**/*.xml")
          }
      - format: |
          ("properties") {
            // specify license header text
            licenseHeader("../licenses/LICENSE_HEADER_SHARPED", """^(?!\s*#).*""", "")
            // include source files
            target("**/*.properties")
            // removes any extra whitespace at the beginning of lines
            indentWithSpaces()
          }
      - format:
          ("html") {
            // remove old license header
            replaceRegex("remove license header", """^\s*<--[\s\S]*?-->\s*""", "")
            // specify license header text
            licenseHeader("../licenses/LICENSE_HEADER_TAGGED", "^")
            // include source files
            target("**/*.html")
          }
      - format:
          ("md") {
            // remove old license header
            replaceRegex("remove license header", """^\s*<--[\s\S]*?-->\s*""", "")
            // specify license header text
            licenseHeader("../licenses/LICENSE_HEADER_TAGGED", "^")
            // include source files
            target("**/*.md")
          }
      - format: |
          ("editconfig") {
            // specify license header text
            licenseHeader("../licenses/LICENSE_HEADER_SHARPED", """^(?!\s*#).*""")
            // include source files
            target("**/.editconfig")
            // removes any extra whitespace at the beginning of lines
            indentWithSpaces()
          }
      - format: |
          ("gitignore") {
            // specify license header text
            licenseHeader("../licenses/LICENSE_HEADER_SHARPED", """^(?!\s*#).*""")
            // include source files
            target("**/.gitignore")
            // removes any extra whitespace at the beginning of lines
            indentWithSpaces()
          }
      - format: |
          ("gitattributes") {
            // specify license header text
            licenseHeader("../licenses/LICENSE_HEADER_SHARPED", """^(?!\s*#).*""")
            // include source files
            target("**/.gitattributes")
            // removes any extra whitespace at the beginning of lines
            indentWithSpaces()
          }
      - formats: |
          {
            // exclude source files
            targetExclude(
              "../licenses/LICENSE_HEADER_*",
              "**/generated-src/**",
              "**/build-*/**",
              "**/.idea/**",
              "**/.fleet/**",
              "**/.idea/**",
              "**/.gradle/**",
              "/spotless/**",
              "**/resources/**",
              "**/buildSrc/**"
            )
            // removes any extra whitespace at the end of lines
            trimTrailingWhitespace()
            // adds a newline character to the end of files content
            endWithNewline()
            // adds the ability to have spotless ignore specific portions of a project. The usage looks like the following
            toggleOffOn()
          }
  # Help developers deliver high-quality, efficient code standards that benefit the entire team or organization.
  - sonar:
      properties: |
        {
          property("sonar.host.url", "https://sonarcloud.io")
          property("sonar.organization", "aaziz993")
          property("sonar.projectKey", "aaziz993_compose-multiplatform")
          property("sonar.coverage.jacoco.xmlReportPaths", "build/reports/kover/report.xml")
          property("sonar.androidLint.reportPaths", "build/reports/lint-results.xml")
        }
  # Api that you can use to develop lightweight compiler plugins. KSP provides a simplified compiler plugin API that leverages the power of Kotlin while keeping the learning curve at a minimum. Compared to KAPT, annotation processors that use KSP can run up to 2x faster.
  - ksp:
      # room
      - arg: ("room.schemaLocation", "schemas")
      - arg: ("room.incremental", "true")
      - arg: ("room.expandProjection", "true")
      - arg: ("room.generateKotlin", "true")
  # Abstraction layer over SQLite to allow for more robust database access while harnessing the full power of SQLite.
  - room:
      - schemaDirectory: ("schemas")
  - dependencies:
      - add: ("kspCommonMainMetadata", libs("arrow.optics.ksp.plugin"))
      - add: ("kspCommonMainMetadata", libs("androidx.room.compiler"))
      - add: ("kspCommonMainMetadata", libs("ktorfit.ksp"))
      # Use import org.koin.ksp.generated.* in project.
      - add: ("kspCommonMainMetadata", libs("koin.ksp.compiler"))
      # knit
      - testImplementation: ("org.jetbrains.kotlinx:kotlinx-knit-test")
#  - tasks:
#      - withType<ShadowJar>: |
#          { shadowJar ->
#              shadowJar.duplicatesStrategy = DuplicatesStrategy.EXCLUDE
#              shadowJar.mergeServiceFiles()
#          }

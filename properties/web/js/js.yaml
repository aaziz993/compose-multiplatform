config:
  imports:
    - org.jetbrains.kotlin.gradle.targets.js.dsl.KotlinJsTargetDsl
    - org.jetbrains.kotlin.gradle.targets.js.webpack.KotlinWebpackConfig
    - gradle.plugins.karakum.*
script:
  - plugins:
      # Converter of TypeScript declaration files to Kotlin declarations.
      - id: (libs.plugins("karakum").pluginId)
  - kotlin:
      js: |
        {
          browser()
          nodejs()
        }
      targets:
        - withType<KotlinJsTargetDsl>: |
            {
              compilerOptions {
                target /= "es2015"
                freeCompilerArgs.addAll(listOf(
                    "-Xdont-warn-on-error-suppression",
                    // https://youtrack.jetbrains.com/issue/KT-67355
                    "-Xir-generate-inline-anonymous-functions",
                    "-Xpartial-linkage-loglevel=ERROR",
                    "-Xexplicit-api=strict"
                ))

                optIn.addAll(listOf(
                  "kotlin.js.ExperimentalJsExport",
                ))
              }
            }
      sourceSets:
        - named: |
            ("jsMain") { sourceSet ->
              sourceSet.dependencies {
                implementation(libs["seskar"])
                implementation(libs["kstore.storage"])
                implementation(libs["sqldelight.web.worker.driver"])
                implementation(libs["compass.geolocation.browser"])
                implementation(libs["worldwind"])
                implementation(libs("ktor")["client.js"])
                implementation(npm("@js-joda/timezone", libs.versions("npm.js.joda.timezone").requiredVersion))
                implementation(devNpm("copy-webpack-plugin", libs.versions("npm.copy.webpack.plugin").requiredVersion))
                implementation(npm("openpgp", libs.versions("npm.openpgp").requiredVersion))
                implementation(npm("pako", libs.versions("npm.pako").requiredVersion))
                implementation(npm("puppeteer", libs.versions("npm.puppeteer").requiredVersion))
              }
            }
        - named: |
            ("jsTest") { sourceSet ->
              sourceSet.dependencies {
                implementation(kotlin("test-js"))
              }
            }

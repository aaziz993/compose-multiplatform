config:
  imports:
    - org.jetbrains.kotlin.gradle.targets.js.dsl.KotlinJsTargetDsl
    - org.jetbrains.kotlin.gradle.tasks.Kotlin2JsCompile
    - org.jetbrains.kotlin.gradle.targets.js.npm.tasks.KotlinNpmInstallTask
    - org.jetbrains.kotlin.gradle.targets.js.yarn.YarnPlugin
    - org.jetbrains.kotlin.gradle.targets.js.yarn.YarnLockMismatchReport
    - org.jetbrains.kotlin.gradle.targets.js.yarn.YarnRootExtension
    - org.jetbrains.kotlin.gradle.targets.js.nodejs.NodeJsRootPlugin
script:
  # TODO remove if https://youtrack.jetbrains.com/issue/KT-55701 provides a better
  - rootProject.plugins.withType<YarnPlugin>: |
      {
        rootProject.yarn.yarnLockMismatchReport = YarnLockMismatchReport.WARNING // NONE | FAIL
        rootProject.yarn.reportNewYarnLock = true
        rootProject.yarn.yarnLockAutoReplace = true
      }
  # TODO Remove when it's fixed https://github.com/antelle/argon2-browser/issues/81
  - rootProject.plugins.withType<NodeJsRootPlugin>: |
      {
        rootProject.nodeJsEnv.version /= "24.7.0"
      }
  - kotlin:
      targets:
        - withType<KotlinJsTargetDsl>: |
            {
              compilerOptions.optIn.addAll(
                "kotlin.js.ExperimentalJsExport",
              )

              browser {
                val rootDirPath = project.rootDir.path
                val projectDirPath = project.projectDir.path

                commonWebpackConfig { commonWebpackConfig ->
                  commonWebpackConfig.devServer = (commonWebpackConfig.devServer ?: KotlinWebpackConfig.DevServer()).apply {
                      static = (static ?: mutableListOf()).apply {
                          // Serve sources to debug inside browser
                          add(rootDirPath)
                          add(projectDirPath)
                      }
                  }

                  commonWebpackConfig.cssSupport { cssSupport ->
                    cssSupport.enabled /= true
                  }
                }

                testTask { testTask ->
                  testTask.testLogging { testLogging ->
                      testLogging.showStandardStreams = true
                  }

                  testTask.useKarma {
                      useChromeHeadless()
                  }
                }
              }
              generateTypeScriptDefinitions()
            }
  - tasks:
      - withType<KotlinNpmInstallTask>: |
          {
            args.addAll(listOf(
              "--ignore-engines",
              "--ignore-scripts",
            ))
          }
      - withType<Kotlin2JsCompile>: |
          {
            compilerOptions {
                target /= "es2015"
                freeCompilerArgs.addAll(
                    "-Xdont-warn-on-error-suppression",
                    //  https://youtrack.jetbrains.com/issue/KT-67355
                    "-Xir-generate-inline-anonymous-functions",
                    "Xwarning-level=NOTHING_TO_INLINE:disabled",
                    "-Xpartial-linkage-loglevel=ERROR",
                )
            }
          }

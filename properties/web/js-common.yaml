config:
  imports:
    - org.jetbrains.kotlin.gradle.targets.js.dsl.KotlinJsTargetDsl
    - org.jetbrains.kotlin.gradle.tasks.Kotlin2JsCompile
    - org.jetbrains.kotlin.gradle.targets.js.npm.tasks.KotlinNpmInstallTask
script:
  - kotlin:
      targets:
        # apply to all above js and wasm targets
        - withType<KotlinJsTargetDsl>: |
            {
              compilerOptions.optIn.addAll(
                "kotlin.js.ExperimentalJsExport",
              )

              browser {
                val rootDirPath = project.rootDir.path
                val projectDirPath = project.projectDir.path

                commonWebpackConfig { commonWebpackConfig ->
                  commonWebpackConfig.devServer = (commonWebpackConfig.devServer ?: KotlinWebpackConfig.DevServer()).apply {
                      static = (static ?: mutableListOf()).apply {
                          // Serve sources to debug inside browser
                          add(rootDirPath)
                          add(projectDirPath)
                      }
                  }

                  commonWebpackConfig.cssSupport { cssSupport ->
                    cssSupport.enabled /= true
                  }
                }

                testTask { testTask ->
                  testTask.testLogging { testLogging ->
                      testLogging.showStandardStreams = true
                  }
            
                  testTask.useKarma {
                      useChromeHeadless()
                  }
                }
              }
            }
  - tasks:
      - withType<KotlinNpmInstallTask>: |
          {
            args.addAll(listOf(
              "--ignore-engines",
              "--ignore-scripts",
            ))
          }
      - withType<Kotlin2JsCompile>: |
          {
            compilerOptions {
                target /= "es2015"
                freeCompilerArgs.addAll(
                    "-Xdont-warn-on-error-suppression",
                    //  https://youtrack.jetbrains.com/issue/KT-67355
                    "-Xir-generate-inline-anonymous-functions",
                    "-Xsuppress-warning=NOTHING_TO_INLINE",
                    "-Xpartial-linkage-loglevel=ERROR",
                )
            }
          }


imports:
  - properties/config.yaml
  - properties/initialization-meta.yaml
config:
  imports:
    - org.gradle.api.initialization.resolve.RepositoriesMode
    - org.gradle.caching.http.HttpBuildCache
    - com.gradle.develocity.agent.gradle.buildcache.DevelocityBuildCache
    - gradle.api.initialization.*
    - gradle.api.ci.CI
    - gradle.plugins.githooks.*
script:
  - enableFeaturePreview: ("TYPESAFE_PROJECT_ACCESSORS")
  - pluginManagement:
      repositories:
        - google: |
            { repository ->
              repository.mavenContent { mavenContent ->
                mavenContent.includeGroupAndSubgroups("androidx")
                mavenContent.includeGroupAndSubgroups("com.android")
                mavenContent.includeGroupAndSubgroups("com.google")
              }
            }
        - mavenCentral: ()
        - gradlePluginPortal: ()
        - maven: ("https://company/com/maven2")
        - maven: ("https://packages.jetbrains.team/maven/p/ij/intellij-dependencies")
  - plugins:
      # Settings plugins.
      - alias: (libs.plugins("develocity"))
      - alias: (libs.plugins("develocityCommonCustomUserData"))
      - alias: (libs.plugins("foojayResolverConvention"))
      - alias: (libs.plugins("gradlePreCommitGitHooks"))
  # Gives the data to speed up your build, improve build reliability and accelerate build debugging.
  # servers: https://ge.solutions-team.gradle.com, https://ge.jetbrains.com
  - develocity:
      server: '"https://ge.solutions-team.gradle.com"'
      buildScan:
        - tag: (if (CI == null) "Local" else "CI")
        - tag: (System.getProperty("os.name"))
        - buildScanPublished: |
            { buildScanPublished ->
                layout.rootDirectory.file("scan-journal.log").asFile.appendText("${Date()} — ${buildScanPublished.buildScanUri} — $startParameter\n")
            }
        - termsOfUseUrl: '"https://gradle.com/help/legal-terms-of-use"'
        - termsOfUseAgree: '"yes"'
        # By default, Build Scans are uploaded in the background after the build has finished.
        # This allows the build to finish sooner, but can be problematic in build environments (e.g. ephemeral CI agents) that terminate as soon as the build is finished, as the upload may be terminated before it completes.
        # Background uploading should be disabled for such environments.
        - uploadInBackground: CI == null
        - publishing: |
            { publishing ->
              publishing.onlyIf { context ->
                context.isAuthenticated && (context.buildResult.failures.isNotEmpty() || CI != null)
              }
            }
        # obfuscate NIC since we don't want to expose user real IP (will be relevant without VPN)
        - obfuscation:
            ipAddresses: |
              { addresses ->
                addresses.map { _ -> "0.0.0.0" }
              }
            hostname: |
              {
                "concealed"
              }
            username: |
              { username ->
                CI?.name ?: username
              }
        - capture:
            fileFingerprints: true
            buildLogging: true
      enrichGitData: () # GitHub repo url populated from remote.url if not provided.
  # Provides a repository for downloading JVMs
  - toolchainManagement: '{ }'
  # Enforcing pre-commit and commit-msg Git hooks configuration. Conventional-commits-ready.
  - gitHooks:
      preCommit: |
        {
          // Script from a source, can be a String, URL or File.
          from(layout.settingsDirectory.file("project.sh").asFile)
          // Content can be added at the bottom of the script
          appendScript {
          """
          spotless_pre_commit
          """
          }
        }
      # Applies all above hooks.
      createHooks: (true)
  - dependencyResolutionManagement:
      repositories:
        # For the Android plugin and dependencies
        - google: |
            { repository ->
              repository.mavenContent { mavenContent ->
                mavenContent.includeGroupAndSubgroups("androidx")
                mavenContent.includeGroupAndSubgroups("com.android")
                mavenContent.includeGroupAndSubgroups("com.google")
              }
            }
        - mavenCentral: ()
        # For other Gradle plugins
        - gradlePluginPortal: ()
        # For dev versions of kotlin
        - maven: ("https://maven.pkg.jetbrains.space/kotlin/p/kotlin/dev")
        # For dev versions of compose plugin and dependencies
        - jetbrainsCompose: ()
        # For compose experimental builds
        - maven: ("https://packages.jetbrains.team/maven/p/firework/dev")
        # Sonatype OSS Snapshot Repository
        - maven: ("https://oss.sonatype.org/content/repositories/snapshots")
        - maven: ("https://repo.gradle.org/gradle/libs-releases")
        - maven: ("https://cache-redirector.jetbrains.com/www.jetbrains.com/intellij-repository/releases")
        - maven: ("https://cache-redirector.jetbrains.com/packages.jetbrains.team/maven/p/ij/intellij-dependencies")
        - maven: ("https://cache-redirector.jetbrains.com/download.jetbrains.com/teamcity-repository")
        - maven: ("https://packages.confluent.io/maven/")
        - maven: ("https://jitpack.io")
      versionCatalogs:
        - create: ("kotlinWrappers"){ catalog -> catalog.fromLib(libs["kotlin.wrappers.catalog"]) }
        - create: ("ktor") { catalog -> catalog.fromLib(libs["ktor.version.catalog"]) }
  - enableCacheRedirect: ()
  - buildCache:
      - local:
          isEnabled: CI == null # Default is if not CI.
      # Develocity build cache configured by default
      - remote: |
          (develocity.buildCache) { buildCache ->
            buildCache.isPush = CI != null
          }
  - include: |
      (
        ":bom",
        ":klib",
        ":clib",
        ":compiler",
        ":shared",
        ":compose-app",
        ":server-app",
      )

name: Full Check, Test, Quality & Publish
on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: write
  packages: write
  pull-requests: write
  checks: write

jobs:
  #-------------------------------------------------------------------------------#
  #            Setup                                                              #
  #-------------------------------------------------------------------------------#
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      gradle-cache-key: ${{ steps.cache-gradle.outputs.cache-hit }}
    steps:
      - id: checkout
        name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      - id: setup-java
        name: üì• Setup Java
        uses: actions/setup-java@v4.2.1
        with:
          distribution: temurin
          java-version: 23

      - id: setup-gradle
        name: üì• Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - id: setup-android
        name: üì• Setup Android
        uses: android-actions/setup-android@v3

      - id: cache-gradle
        name: ‚ö° Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/*.gradle.kts', '**/gradle-wrapper.properties') }}

  #-------------------------------------------------------------------------------#
  #            Dependency Check                                                   #
  #-------------------------------------------------------------------------------#
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - id: cancel
        name: üõë Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1

      - id: dependency-check
        name: üî¨ Run Dependency Analysis
        run: ./gradlew ciDependencyCheckAnalyze

  #-------------------------------------------------------------------------------#
  #            Format & Quality Check                                             #
  #-------------------------------------------------------------------------------#
  format-quality-check:
    name: Format & Quality Check
    runs-on: ubuntu-latest
    needs: dependency-check
    steps:
      - id: checkout
        name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      - id: spotless
        name: üî¨ Run Spotless Format Check
        run: ./gradlew ciSpotlessCheck

      - id: sonar
        name: üî¨ Run SonarQube Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: ./gradlew ciSonar

      - id: knit
        name: üî¨ Check Code Samples
        run: ./gradlew ciKnitCheck

  #-------------------------------------------------------------------------------#
  #            Qodana                                                             #
  #            Discover all capabilities of Qodana in our documentation           #
  #            https://www.jetbrains.com/help/qodana/about-qodana.html            #
  #-------------------------------------------------------------------------------#
  qodana:
    runs-on: ubuntu-latest
    needs: format-quality-check
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0
      - name: 'Qodana Scan'
        uses: JetBrains/qodana-action@v2025.2
        env:
          QODANA_TOKEN: ${{ secrets.QODANA_TOKEN }}
        with:
          # In pr-mode: 'true' Qodana checks only changed files
          pr-mode: false
          use-caches: true
          post-pr-comment: true
          use-annotations: true
          # Upload Qodana results (SARIF, other artifacts, logs) as an artifact to the job
          upload-result: false
          # quick-fixes available in Ultimate and Ultimate Plus plans
          push-fixes: 'none'

  #-------------------------------------------------------------------------------#
  #            Tests & Coverage                                                   #
  #-------------------------------------------------------------------------------#
  test-coverage:
    name: Tests & Coverage
    runs-on: ubuntu-latest
    needs: qodana
    steps:
      - id: checkout
        name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      - id: tests
        name: üß™ Run Tests
        run: ./gradlew ciCheck

      - id: kover-report
        name: ‚úÖ Generate Coverage Report
        run: ./gradlew ciKoverReport

      - id: kover-verify
        name: üîç Verify Coverage Thresholds
        run: ./gradlew ciKoverVerify

      - id: upload-tests
        name: üìÅ Upload Test Reports
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: build/test-results/**

      - id: upload-coverage
        name: üìÅ Upload Kover Reports
        uses: actions/upload-artifact@v3
        with:
          name: kover-report
          path: build/reports/kover/**

  #-------------------------------------------------------------------------------#
  #            Publish                                                            #
  #-------------------------------------------------------------------------------#
  publish:
    name: Publish
    runs-on: ubuntu-latest
    needs: test-coverage
    if: success()
    steps:
      - id: checkout
        name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      - id: publish-github-packages
        name: üì¶ Publish GitHub Packages
        env:
          GITHUB_USERNAME: ${{ github.actor }}
          GITHUB_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
          SIGNING_GNUPG_KEY: ${{ secrets.SIGNING_GPG_KEY }}
          SIGNING_GNUPG_KEY_ID: ${{ secrets.SIGNING_GPG_KEY_ID }}
          SIGNING_GNUPG_KEY_PASSPHRASE: ${{ secrets.SIGNING_GPG_KEY_PASSWORD }}
        run: ./gradlew publishAllPublicationsToGithubPackagesRepository

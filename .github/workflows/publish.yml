# This workflow will build a Kotlin Multiplatform project with Gradle and cache/restore any dependencies to improve the workflow execution time
name: Full check and publish.

# Controls when the workflow will run
on:
  # Triggers the workflow on push but only for the main branch
  push:
    branches:
      - main

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  maven:
    name: Code format check, quality check, test and publish
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    # Sets the permissions granted to the `GITHUB_TOKEN` for the actions in this job.
    permissions:
      contents: read
      packages: write
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: ğŸ›‘ Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1

      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ“¥ Setup Java
        uses: actions/setup-java@v4.2.1
        with:
          distribution: 'temurin'
          java-version: 23

      - name: ğŸ“¥ Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: ğŸ“¥ Setup Android
        uses: android-actions/setup-android@v3

      - name:   # ğŸ”¬ Monitor dependent libraries for known, published vulnerabilities.
        run: ./gradlew githubDependencyCheckAnalyze

      - name:  # ğŸ”¬ # Format <antlr | c | c# | c++ | css | flow | graphql | groovy | html | java | javascript | json | jsx | kotlin | less | license headers | markdown | objective-c | protobuf | python | scala | scss | shell | sql | typeScript | vue | yaml | anything> using <gradle | maven | sbt | anything>.
        run: ./gradlew githubSpotlessCheck

      - name:  # ğŸ“ # Format <antlr | c | c# | c++ | css | flow | graphql | groovy | html | java | javascript | json | jsx | kotlin | less | license headers | markdown | objective-c | protobuf | python | scala | scss | shell | sql | typeScript | vue | yaml | anything> using <gradle | maven | sbt | anything>.
        run: ./gradlew githubSpotlessApply

      - name:  # ğŸ”¬Help developers deliver high-quality, efficient code standards that benefit the entire team or organization.
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: ./gradlew githubSonar

      - name:  # ğŸ§ª Run all tests.
        run: ./gradlew githubCheck

      - name:  # âœ… Set of solutions for collecting test coverage of Kotlin code compiled for JVM and Android platforms.
        run: ./gradlew githubKoverVerify

      - name:  # ğŸ“Š Set of solutions for collecting test coverage of Kotlin code compiled for JVM and Android platforms.
        run: ./gradlew githubKoverReport

      - name:  # ğŸ“„ Api documentation engine for Kotlin.
        run: ./gradlew githubDokkaGenerate

      - name:  # ğŸ”¬ Produces Kotlin source example files and tests from markdown documents with embedded snippets of Kotlin code
        run: ./gradlew githubKnitCheck

      - name: # ğŸ“¦ğŸš€ Publish to GitHub Packages.
        env:
          GITHUB_USERNAME: ${{ github.actor }}
          GITHUB_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
          SINGING_GNUPG_KEY_ID: ${{ secrets.SINGING_GNUPG_KEY_ID }}
          SINGING_GNUPG_KEY: ${{ secrets.SINGING_GNUPG_KEY }}
          SIGNING_GNUPG_KEY_PASSPHRASE: ${{ secrets.SIGNING_GNUPG_KEY_PASSPHRASE }}
        run: ./gradlew githubPublishAllPublicationsToGithubPackagesRepository

      - name: # ğŸ“¦ğŸš€ Publish to Jetbrains Space Packages.
        env:
          JB_SPACE_USERNAME: ${{ vars.JB_SPACE_USERNAME }}
          JB_SPACE_PASSWORD: ${{ secrets.JB_SPACE_PASSWORD }}
          SINGING_GNUPG_KEY_ID: ${{ secrets.SINGING_GNUPG_KEY_ID }}
          SINGING_GNUPG_KEY: ${{ secrets.SINGING_GNUPG_KEY }}
          SIGNING_GNUPG_KEY_PASSPHRASE: ${{ secrets.SIGNING_GNUPG_KEY_PASSPHRASE }}
        run: ./gradlew githubPublishAllPublicationsToSpacePackagesRepository

      - name: # ğŸ“¦ğŸš€ Publish to Maven Repository.
        env:
          SONATYPE_USERNAME: ${{ vars.SONATYPE_USERNAME }}
          SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
          SINGING_GNUPG_KEY_ID: ${{ secrets.SINGING_GNUPG_KEY_ID }}
          SINGING_GNUPG_KEY: ${{ secrets.SINGING_GNUPG_KEY }}
          SIGNING_GNUPG_KEY_PASSPHRASE: ${{ secrets.SIGNING_GNUPG_KEY_PASSPHRASE }}
        run: ./gradlew githubPublishAllPublicationsToMavenRepository

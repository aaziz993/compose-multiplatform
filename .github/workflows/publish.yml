name: Full Check, Test, Quality & Publish

on:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write

jobs:
  # -----------------------------
  # Common Setup
  # -----------------------------
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      gradle-cache-key: ${{ steps.cache-gradle.outputs.cache-hit }}
    steps:
      - id: checkout
        name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      - id: setup-java
        name: ğŸ“¥ Setup Java
        uses: actions/setup-java@v4.2.1
        with:
          distribution: temurin
          java-version: 23

      - id: setup-gradle
        name: ğŸ“¥ Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - id: setup-android
        name: ğŸ“¥ Setup Android
        uses: android-actions/setup-android@v3

      - id: cache-gradle
        name: âš¡ Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/*.gradle.kts', '**/gradle-wrapper.properties') }}

  # -----------------------------
  # Dependency Check
  # -----------------------------
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - id: cancel
        name: ğŸ›‘ Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1

      - id: dependency-check
        name: ğŸ”¬ Run Dependency Analysis
        run: ./gradlew ciDependencyCheckAnalyze

  # -----------------------------
  # Format & Quality Check
  # -----------------------------
  format-quality-check:
    name: Format & Quality Check
    runs-on: ubuntu-latest
    needs: dependency-check
    steps:
      - id: checkout
        name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      - id: spotless
        name: ğŸ”¬ Run Spotless Format Check
        run: ./gradlew ciSpotlessCheck

      - id: sonar
        name: ğŸ”¬ Run SonarQube Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: ./gradlew ciSonar

      - id: knit
        name: ğŸ”¬ Check Code Samples
        run: ./gradlew ciKnitCheck

  # -----------------------------
  # Tests & Coverage
  # -----------------------------
  test-coverage:
    name: Tests & Coverage
    runs-on: ubuntu-latest
    needs: format-quality-check
    steps:
      - id: checkout
        name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      - id: tests
        name: ğŸ§ª Run Tests
        run: ./gradlew ciCheck

      - id: kover-report
        name: âœ… Generate Coverage Report
        run: ./gradlew ciKoverReport

      - id: kover-verify
        name: ğŸ” Verify Coverage Thresholds
        run: ./gradlew ciKoverVerify

      - id: upload-tests
        name: ğŸ“ Upload Test Reports
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: build/test-results/**

      - id: upload-coverage
        name: ğŸ“ Upload Kover Reports
        uses: actions/upload-artifact@v3
        with:
          name: kover-report
          path: build/reports/kover/**

  # -----------------------------
  # Publish
  # -----------------------------
  publish:
    name: Publish
    runs-on: ubuntu-latest
    needs: test-coverage
    if: success()
    steps:
      - id: checkout
        name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      - id: publish-github-packages
        name: ğŸ“¦ Publish GitHub Packages
        env:
          GITHUB_USERNAME: ${{ github.actor }}
          GITHUB_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
          SIGNING_GNUPG_KEY: ${{ secrets.SIGNING_GPG_KEY }}
          SIGNING_GNUPG_KEY_ID: ${{ secrets.SIGNING_GPG_KEY_ID }}
          SIGNING_GNUPG_KEY_PASSPHRASE: ${{ secrets.SIGNING_GPG_KEY_PASSWORD }}
        run: ./gradlew publishAllPublicationsToGithubPackagesRepository
